# SPDX-FileCopyrightText: Copyright (c) 2023 - 2025 NVIDIA CORPORATION & AFFILIATES.
# SPDX-FileCopyrightText: All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# ERA5降尺度推理配置文件
#
# 支持自动patch切分：当输入尺寸与模型patch尺寸不匹配时，
# 自动将输入切分成多个patch进行推理，然后拼接还原。
#
# =============================================================================
# 使用示例
# =============================================================================
#
# 1. 基本用法（自动从模型获取patch尺寸）:
#    python inference_era5.py \
#        --input_dir ./data/era5_lr/ \
#        --output_dir ./outputs/era5_hr/ \
#        --reg_ckpt ./checkpoints/regression.mdlus \
#        --stats_path ./data/stats.json
#
# 2. 手动指定patch尺寸:
#    python inference_era5.py \
#        --input_dir ./data/era5_lr/ \
#        --output_dir ./outputs/era5_hr/ \
#        --reg_ckpt ./checkpoints/regression.mdlus \
#        --stats_path ./data/stats.json \
#        --patch_shape 448 448 \
#        --overlap_pix 32
#
# 3. 使用回归+扩散模型，生成10个集合成员:
#    python inference_era5.py \
#        --input_dir ./data/era5_lr/ \
#        --output_dir ./outputs/era5_hr/ \
#        --reg_ckpt ./checkpoints/regression.mdlus \
#        --res_ckpt ./checkpoints/diffusion.mdlus \
#        --stats_path ./data/stats.json \
#        --num_ensembles 10 \
#        --patch_shape 448 448
#
# =============================================================================
# 参数说明
# =============================================================================
#
# --input_dir       输入文件夹路径（包含单时间戳ERA5 nc文件）
# --output_dir      输出文件夹路径
# --reg_ckpt        回归模型检查点路径
# --res_ckpt        扩散模型检查点路径（可选）
# --stats_path      归一化统计信息JSON文件路径
# --num_ensembles   集合成员数量（默认: 1）
# --num_steps       扩散采样步数（默认: 18）
# --patch_shape     模型patch尺寸 H W（不指定则从模型自动获取）
# --overlap_pix     patch重叠像素数（默认: 32，用于平滑拼接）
# --boundary_pix    边界像素数（默认: 0）
# --device          计算设备（默认: cuda）
# --fp16            使用半精度
# --save_input      在输出nc中保存输入数据
# --file_pattern    输入文件匹配模式（默认: *.nc）
#
# =============================================================================
# 输入文件格式要求
# =============================================================================
#
# - 每个nc文件包含单个时间戳的ERA5数据
# - 维度: lat/latitude, lon/longitude, (可选: time)
# - 变量: 气象变量如 t2m, u10, v10 等
# - 尺寸: 任意尺寸，脚本会自动切分成模型支持的patch
#
# =============================================================================
# 输出文件格式
# =============================================================================
#
# - 每个输入文件对应一个输出文件
# - 输出文件名: {输入文件名}_downscaled.nc
# - 维度: time, (ensemble), lat, lon
# - 变量: 与输入变量对应的高分辨率预测
# - 格式: 符合CF-1.6规范
#
# =============================================================================
# Patch切分说明
# =============================================================================
#
# 当输入图像尺寸大于模型patch尺寸时，脚本会自动：
# 1. 将输入切分成多个重叠的patch
# 2. 对每个patch分别进行推理
# 3. 使用加权平均将所有patch拼接还原为原始尺寸
#
# overlap_pix 参数控制相邻patch之间的重叠区域大小，
# 较大的重叠可以减少拼接边界处的伪影，但会增加计算量。
# 推荐值: 16-64 像素
